<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®å¾Œå°ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .filter-btn:hover:not(.active) {
            border-color: #007bff;
            color: #007bff;
        }

        .filter-btn[data-filter="history"] {
            border-color: #6c757d;
            color: #6c757d;
        }

        .filter-btn[data-filter="history"].active {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .orders-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
            position: relative;
        }

        .order-card.pending {
            border-left-color: #ffc107;
        }

        /* .order-card.preparing {
            border-left-color: #007bff;
        } */

        .order-card.completed {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .order-card.pending_payment{
            border-left-color:#007bff;
        }

        .order-card.history {
            border-left-color: #6c757d;
            opacity: 0.8;
            background: #f8f9fa;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .order-number {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .table-badge {
            background: #007bff;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .history-badge {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            position: absolute;
            top: 12px;
            right: 12px;
        }

        .order-time {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .arrival-time {
            color: #e74c3c;
            font-size: 14px;
            font-weight: 500;
        }

        .order-items {
            margin: 16px 0;
        }

        .order-item {
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
            font-size: 14px;
            line-height: 1.4;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .item-details {
            color: #6c757d;
            font-size: 13px;
            margin-top: 2px;
        }

        .order-total {
            text-align: right;
            font-size: 18px;
            font-weight: 700;
            color: #e74c3c;
            margin: 16px 0;
            padding-top: 16px;
            border-top: 2px solid #f8f9fa;
        }

        .status-controls {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .order-card.history .status-controls {
            display: none;
        }

        .status-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .status-btn.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* .status-btn.preparing {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        } */

        .status-btn.completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-btn.pending_payment{
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .status-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-btn.active {
            font-weight: 700;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .stats-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-item p {
            color: #6c757d;
            font-size: 14px;
        }

        .stat-item.pending h3 { color: #ffc107; }
        /* .stat-item.preparing h3 { color: #007bff; } */
        .stat-item.completed h3 { color: #28a745; }
        .stat-item.pending_payment h3{color:#007bff;}
        .stat-item.history h3 { color: #6c757d; }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .side-dishes {
            margin: 16px 0;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .side-dish-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            font-size: 14px;
            gap: 8px;
        }

        .side-dish-row label {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .side-dish-name {
            min-width: 60px;
            flex-shrink: 0;
        }

        .side-dish-input {
            width: 45px !important;
            padding: 3px 6px;
            font-size: 13px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .side-dish-unit {
            font-size: 13px;
            color: #666;
            margin: 0 4px;
            flex-shrink: 0;
        }

        .side-dish-price {
            min-width: 50px;
            text-align: right;
            color: #666;
            font-size: 13px;
            flex-shrink: 0;
        }

        .side-dish-row input {
            width: 60px;
            padding: 4px;
            font-size: 13px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .side-dishes-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .btn-action {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add {
            background: #28a745;
            color: white;
        }
        .btn-add:hover {
            background: #218838;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }
        .btn-remove:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-buttons {
                justify-content: center;
            }

            .orders-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }
            /* åœ¨ç¬¬ 283 è¡Œé™„è¿‘æ·»åŠ  */
.stat-item.unassigned h3 { color: #6f42c1; }

.order-card.unassigned {
    border-left-color: #6f42c1;
}

.status-btn.unassigned {
    background: #e7d6ff;
    color: #5a2d82;
    border: 1px solid #d1b3ff;
}

/* æ¡Œè™Ÿä¸‹æ‹‰é¸å–®æ¨£å¼ */
.table-select {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    background-color: white;
    cursor: pointer;
}

.table-select:focus {
    outline: none;
    border-color: #6f42c1;
    box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.2);
}

.table-select option {
    padding: 8px;
}

/* æ¡Œè™Ÿè¼¸å…¥å€åŸŸæ¨£å¼ */
.table-input-section {
    margin: 16px 0;
    padding: 12px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
}

.table-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.table-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.confirm-table-btn {
    padding: 8px 16px;
    background: #6f42c1;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}

.confirm-table-btn:hover:not(:disabled) {
    background: #5a2d82;
}

.confirm-table-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸœ è¨‚å–®ç®¡ç†å¾Œå°</h1>
            <div class="status-indicator">
                <div id="connectionStatus" class="connection-status disconnected">
                    ğŸ”´ åˆå§‹åŒ–ä¸­...
                </div>
                <div style="color: #6c757d;">
                    <span id="currentTime">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- éŒ¯èª¤/æˆåŠŸè¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
        <div id="messageContainer"></div>

        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item unassigned">
                <h3 id="unassignedCount">0</h3>
                <p>å¾…åˆ†é…</p>
            </div>
            <div class="stat-item pending">
                <h3 id="pendingCount">0</h3>
                <p>å¾…è™•ç†</p>
            </div>
            <div class="stat-item pending_payment">
                <h3 id="pending_paymentCount">0</h3>
                <p>å¾…çµå¸³</p>
            </div>
            <div class="stat-item completed">
                <h3 id="completedCount">0</h3>
                <p>å·²å®Œæˆ</p>
            </div>
            <div class="stat-item history">
                <h3 id="historyCount">0</h3>
                <p>æ­·å²è¨‚å–®</p>
            </div>
        </div>
        <!-- æ§åˆ¶é¢æ¿
        <div class="controls">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">å…¨éƒ¨è¨‚å–®</button>
                <button class="filter-btn" data-filter="pending">å¾…è™•ç†</button>
                <button class="filter-btn" data-filter="preparing">è£½ä½œä¸­</button> -->
                <!-- <button class="filter-btn" data-filter="pending_payment">å¾…çµå¸³</button>
                <button class="filter-btn" data-filter="completed">å·²å®Œæˆ</button>
                <button class="filter-btn" data-filter="history">æ­·å²è¨‚å–®</button>
            </div>
            <button class="refresh-btn" onclick="loadOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div> -->
       
        <div class="controls">
            <div class="filter-buttons">
                <button class="filter-btn" data-filter="all">å…¨éƒ¨è¨‚å–®</button>
                <button class="filter-btn active" data-filter="unassigned">å¾…åˆ†é…</button>
                <button class="filter-btn" data-filter="pending">å¾…è™•ç†</button>
                <button class="filter-btn" data-filter="pending_payment">å¾…çµå¸³</button>
                <button class="filter-btn" data-filter="completed">å·²å®Œæˆ</button>
                <button class="filter-btn" data-filter="history">æ­·å²è¨‚å–®</button>
            </div>
            <button class="refresh-btn" onclick="loadOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>

        <!-- è¨‚å–®åˆ—è¡¨ -->
        <div class="orders-grid" id="ordersGrid">
            <div class="loading-spinner">
                <h3>è¼‰å…¥ä¸­...</h3>
                <p>æ­£åœ¨å–å¾—è¨‚å–®è³‡æ–™</p>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®è¨­å®š
        const API_BASE_URL = 'https://test-node-js-e6du.onrender.com/api'; // å¯ä»¥ä¿®æ”¹ç‚ºä½ çš„å¯¦éš›APIç¶²å€
        
        async function checkAdminAuth() {
            const token = sessionStorage.getItem('adminToken');
            
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('é©—è­‰å¤±æ•—:', error);
                sessionStorage.clear();
                window.location.href = 'login.html';
                return false;
            }
        }

        // é é¢è¼‰å…¥æ™‚å…ˆé©—è­‰
        checkAdminAuth();

        // å…¨åŸŸè®Šæ•¸
        let orders = [];
        let currentFilter = 'unassigned'; // ä¿®æ­£ï¼šé è¨­ç‚º 'all'
        let autoRefreshInterval;
        let currentTimeInterval;
        const sideDishes = [
                {name: 'è±†å¹²', price: 5},
                {name: 'æ»·è›‹', price: 10},
                {name: 'æµ·å¸¶', price: 10},
                {name: 'ç´ é›', price: 15},
                {name: 'è±†çš®', price: 15},
                {name: 'èŠ±å¹²', price: 25},
                {name: 'è±¬çš®', price: 25},
                {name: 'èŠ±ç”Ÿ', price: 35},
                {name: 'æ¶¼èœ', price: 35},
                {name: 'ç”œä¸è¾£', price: 10},
                {name: 'å¤§è±†å¹²', price: 20},
                {name: 'è±¬è¡€ç³•', price: 20},
                {name: 'è±¬è€³æœµ', price: 35},
                {name: 'è±¬é ­çš®', price: 35},
                {name: 'ç™¾é è±†è…', price: 20}
        ];

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.textContent = message;
           
            container.innerHTML = '';
            container.appendChild(messageDiv);
           
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // æ ¼å¼åŒ–æ™‚é–“ç‚ºå°ç£æ™‚é–“
        function formatTaiwanTime(dateString, options = {}) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'æ™‚é–“éŒ¯èª¤';
               
                const defaultOptions = {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    ...options
                };
               
                return date.toLocaleString('zh-TW', defaultOptions);
            } catch (error) {
                return 'æ™‚é–“è§£æéŒ¯èª¤';
            }
        }

        function isToday(dateString) {
            try {
                const orderDate = new Date(dateString);
                const now = new Date();
               
                // è½‰æ›ç‚ºå°ç£æ™‚å€é€²è¡Œæ¯”è¼ƒ
                const orderDateTW = new Date(orderDate.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
                const todayStartTW = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
                todayStartTW.setHours(0, 0, 0, 0);

                return orderDateTW >= todayStartTW;
            } catch (error) {
                console.error('æ—¥æœŸåˆ¤æ–·éŒ¯èª¤:', error);
                return true;
            }
        }

        // å–å¾—è¨‚å–®åˆ†é¡
        function getOrderCategory(order) {
            const checkTime = order.pickup_time || order.created_at;
            const isTodayOrder = isToday(checkTime);
       
            if (!isTodayOrder) {
                return 'history';
            }
       
            // è‡ªå‹•åˆ¤æ–·ï¼šæ²’æœ‰æ¡Œè™Ÿçš„è¨‚å–®æ­¸é¡ç‚ºæœªæŒ‡å®šç‹€æ…‹
            // åˆ¤æ–·é‚è¼¯ï¼šåªæœ‰çœŸæ­£æ²’æœ‰æ¡Œè™Ÿæˆ–æ˜ç¢ºæ¨™è¨˜ç‚ºå¾…åˆ†é…çš„æ‰æ­¸é¡ç‚ºå¾…åˆ†é…
            if ((!order.table_number || order.table_number === '' || order.table_number === null || order.table_number === undefined || order.table_number === 'å¾…åˆ†é…') 
                && order.table_number !== 'å¤–å¸¶') {
                return 'unassigned';
            }

            return order.status || 'pending';
        }

        // æ›´æ–°ç•¶å‰æ™‚é–“
        function updateCurrentTime() {
            const currentTimeElement = document.getElementById('currentTime');
            if (currentTimeElement) {
                currentTimeElement.textContent = formatTaiwanTime(new Date(), {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }

        // æ›´æ–°é€£ç·šç‹€æ…‹
        function updateConnectionStatus(message, status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = `connection-status ${status}`;
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
        const todayOrders = orders.filter(o => isToday(o.created_at));
        const historyOrders = orders.filter(o => !isToday(o.created_at));

        // ä½¿ç”¨ getOrderCategory ä¾†åˆ¤æ–·ï¼Œè€Œä¸æ˜¯ç›´æ¥çœ‹ status
        const pending = todayOrders.filter(o => getOrderCategory(o) === 'pending').length;
        const unassigned = todayOrders.filter(o => getOrderCategory(o) === 'unassigned').length;
        const pending_payment = todayOrders.filter(o => o.status ==='pending_payment').length;
        const completed = todayOrders.filter(o => o.status === 'completed').length;
        const history = historyOrders.length;

        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('unassignedCount').textContent = unassigned;
        document.getElementById('pending_paymentCount').textContent = pending_payment;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('historyCount').textContent = history;
    }

        // å–å¾—ç‹€æ…‹ä¸­æ–‡åç¨±
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…è™•ç†',
                'unassigned': 'å¾…åˆ†é…',
                'pending_payment':'å¾…çµå¸³',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        function renderOrderCard(order) {
            const isTodayOrder = isToday(order.created_at);
            const orderCategory = getOrderCategory(order);
            const orderTime = formatTaiwanTime(order.created_at, {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            let arrivalTime;
            let arrivalLabel;
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºå…§ç”¨é ç´„ï¼ˆæœ‰pickup_timeä¸”ä¸æ˜¯å¤–å¸¶ä¸”æ¡Œè™Ÿæ˜¯å¾…åˆ†é…ï¼‰
            const isReservation = order.pickup_time && 
                order.table_number !== 'å¤–å¸¶' && 
                (order.table_number === 'å¾…åˆ†é…' || !order.table_number || order.table_number === '');
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºå…§ç”¨é ç´„ä½†å·²åˆ†é…æ¡Œè™Ÿï¼ˆå¾å¾…åˆ†é…è½‰åˆ°å¾…è™•ç†ï¼‰
            const isAssignedReservation = order.pickup_time && 
                order.table_number !== 'å¤–å¸¶' && 
                order.table_number !== 'å¾…åˆ†é…' && 
                order.table_number && 
                order.table_number !== '';
            
            if (order.table_number === 'å¤–å¸¶' && order.pickup_time) {
                // å¤–å¸¶è¨‚å–®ï¼šé¡¯ç¤ºé ç´„å–é¤æ™‚é–“
                arrivalTime = formatTaiwanTime(order.pickup_time, { hour: '2-digit', minute: '2-digit' });
                arrivalLabel = 'é ç´„å–é¤ï¼š';
            } else if (isReservation) {
                // å…§ç”¨é ç´„ï¼ˆå¾…åˆ†é…ï¼‰ï¼šé¡¯ç¤ºé ç´„ç”¨é¤æ™‚é–“
                arrivalTime = formatTaiwanTime(order.pickup_time, { hour: '2-digit', minute: '2-digit' });
                arrivalLabel = 'é ç´„ç”¨é¤ï¼š';
            } else if (isAssignedReservation) {
                // å…§ç”¨é ç´„ï¼ˆå·²åˆ†é…æ¡Œè™Ÿï¼‰ï¼šé¡¯ç¤ºé ä¼°å®Œæˆæ™‚é–“ï¼ˆé ç´„æ™‚é–“+20åˆ†é˜ï¼‰
                const estimatedCompleteTime = new Date(new Date(order.pickup_time).getTime() + 20 * 60 * 1000);
                arrivalTime = formatTaiwanTime(estimatedCompleteTime, { hour: '2-digit', minute: '2-digit' });
                arrivalLabel = 'é ä¼°å®Œæˆï¼š';
            } else {
                // å…§ç”¨å³æ™‚é»é¤ï¼šé¡¯ç¤ºé ä¼°å®Œæˆæ™‚é–“ï¼ˆä¸‹å–®å¾Œ20åˆ†é˜ï¼‰
                const estimatedCompleteTime = new Date(new Date(order.created_at).getTime() + 20 * 60 * 1000);
                arrivalTime = formatTaiwanTime(estimatedCompleteTime, { hour: '2-digit', minute: '2-digit' });
                arrivalLabel = 'é ä¼°å®Œæˆï¼š';
            }

            // è™•ç†è¨‚å–®é …ç›®
            let itemsHTML = '';
            if (order.parsed_items && order.parsed_items.length > 0) {
                itemsHTML = order.parsed_items.map(item => {
                    let customOptions = {};
                    try {
                        customOptions = item.custom_options ?
                            (typeof item.custom_options === 'string' 
                            ? JSON.parse(item.custom_options) 
                            : item.custom_options) : {};
                    } catch (e) { customOptions = {}; }
                    const optionsText = Object.keys(customOptions).length > 0 
                        ? Object.values(customOptions).join('ï½œ')   
                        : '';
                    return `
                        <div class="order-item">
                            <div class="item-name">${item.item_name} Ã— ${item.quantity}</div>
                            ${optionsText ? `<div class="item-details">${optionsText}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            // æ¡Œè™Ÿ / å¤–å¸¶é¡¯ç¤º
            let tableDisplay = 'å¾…åˆ†é…';
            if (order.table_number) {
                if (order.table_number === 'å¤–å¸¶' || (order.table_number && order.table_number.toLowerCase && order.table_number.toLowerCase() === 'takeout')) {
                    tableDisplay = 'å¤–å¸¶';
                } else if (order.table_number !== 'å¾…åˆ†é…') {
                    tableDisplay = `${order.table_number}è™Ÿæ¡Œ`;
                }
            }

                const currentStatus = order.status || 'pending';
                // æ¡Œè™Ÿé¸æ“‡é‚è¼¯ - ä½¿ç”¨ä¸‹æ‹‰é¸å–®
                let tableInputSection = '';
                if (orderCategory === 'unassigned') {
                    tableInputSection = `
                        <div class="table-input-section">
                            <div class="table-input-row">
                                <select class="table-select" id="tableSelect-${order.id}" onchange="assignTableFromDropdown(${order.id})">
                                    <option value="">è«‹é¸æ“‡æ¡Œè™Ÿ</option>
                                    <option value="å¤–å¸¶">å¤–å¸¶</option>
                                    <option value="1">1è™Ÿæ¡Œ</option>
                                    <option value="2">2è™Ÿæ¡Œ</option>
                                    <option value="3">3è™Ÿæ¡Œ</option>
                                    <option value="4">4è™Ÿæ¡Œ</option>
                                    <option value="5">5è™Ÿæ¡Œ</option>
                                    <option value="6">6è™Ÿæ¡Œ</option>
                                    <option value="7">7è™Ÿæ¡Œ</option>
                                </select>
                            </div>
                        </div>
                    `;
                }
                // å°èœå°ˆå€ï¼ˆç”¨ä¸‹æ‹‰é¸å–®é¸æ“‡æ•¸é‡ï¼‰
                const sideDishesHtml = order.status === 'pending_payment' ? `
                <div class="side-dishes">
                    <details>
                        <summary>ğŸ´ å°èœå°ˆå€</summary>
                        <div class="side-dish-list">
                            ${sideDishes.map(dish => `
                                <label>
                                    ${dish.name}
                                    <select data-name="${dish.name}" data-price="${dish.price}" onchange="updateTotal(${order.id})">
                                        ${[0,1,2,3,4,5].map(n => `<option value="${n}">${n}</option>`).join('')}
                                    </select> ä»½ Ã— $${dish.price}
                                </label><br>
                            `).join('')}
                        </div>

                        <!-- å°èœæ“ä½œæŒ‰éˆ• -->
                        <div class="side-dishes-actions">
                            <button class="btn-action btn-add" onclick="addSideDishes(${order.id})">âœ… åŠ å…¥å°èœ</button>
                            <button class="btn-action btn-remove" onclick="removeSideDishes(${order.id})">âŒ åˆªé™¤å°èœ</button>
                        </div>
                    </details>
                </div>
                ` : '';

            // å¦‚æœä¸æ˜¯ä»Šæ—¥å‰‡åˆ—ç‚ºæ­·å²ï¼Œä½¿ç”¨ history æ¨¡æ¿
            if (orderCategory === 'history') {
                return `
                    <div class="order-card history" data-order-id="${order.id}">
                        <span class="history-badge">æ­·å²</span>
                        <div class="order-header">
                            <div>
                                <div class="order-number">è¨‚å–® #${order.id}</div>
                                <div class="order-time">${orderTime}</div>
                            </div>
                            <div class="table-badge">${tableDisplay}</div>
                        </div>
                        <div class="order-items">${itemsHTML || '<p>ç„¡é¤é»è³‡æ–™</p>'}</div>
                        <div class="order-total">NT$ ${Number(order.total_price || 0).toFixed(0)}</div>
                        <div style="text-align:right; font-size:13px; color:#6c757d;">ç‹€æ…‹ï¼š${getStatusText(currentStatus)}</div>
                    </div>
                `;
                }

                // ä»Šæ—¥è¨‚å–® template
                return `
                <div class="order-card ${currentStatus}" data-order-id="${order.id}">
                <div class="order-header">
                    <div>
                        <div class="order-number">è¨‚å–® #${order.id}</div>
                        <div class="order-time">${orderTime}</div>
                        <div class="arrival-time">${arrivalLabel}${arrivalTime}</div>
                    </div>
                    <div class="table-badge">${tableDisplay}</div>
                </div>
                <div class="order-items">
                    ${itemsHTML || '<p>ç„¡é¤é»è³‡æ–™</p>'}
                </div>

                    ${tableInputSection}
                    ${sideDishesHtml}
                        <div class="order-total" id="total-${order.id}" data-base="${Number(order.total_price).toFixed(0)}">
                        NT$ ${Number(order.total_price).toFixed(0)}
                        </div>
                        <div class="status-controls">
                            <button class="status-btn pending ${currentStatus === 'pending' ? 'active' : ''}"
                                    onclick="updateOrderStatus(${order.id}, 'pending')">å¾…è™•ç†</button>
                            <button class="status-btn pending_payment ${currentStatus === 'pending_payment' ? 'active' : ''}"
                                    onclick="updateOrderStatus(${order.id}, 'pending_payment')">å¾…çµå¸³</button>
                            <button class="status-btn completed ${currentStatus === 'completed' ? 'active' : ''}"
                                    onclick="updateOrderStatus(${order.id}, 'completed')">å·²å®Œæˆ</button>
                        </div>
                    </div>
                `;
        }
        function renderOrders() {
            const ordersGrid = document.getElementById('ordersGrid');
            let filteredOrders = [...orders];

            // æ ¹æ“šç¯©é¸å™¨éæ¿¾è¨‚å–®
            if (currentFilter === 'unassigned') {
                filteredOrders = orders.filter(order =>
                    isToday(order.created_at) && getOrderCategory(order) === 'unassigned'
                );
            } else if (currentFilter === 'history') {
                filteredOrders = orders.filter(order => !isToday(order.created_at));
            } else if (currentFilter === 'all') {
                filteredOrders = orders;
            } else {
                // å…¶ä»–ç‹€æ…‹ç¯©é¸
                if (currentFilter === 'pending') {
                    filteredOrders = orders.filter(order =>
                        isToday(order.created_at) && getOrderCategory(order) === 'pending'
                    );
                } else {
                    filteredOrders = orders.filter(order =>
                        isToday(order.created_at) && (order.status || 'pending') === currentFilter
                    );
                }
            }

            // æŒ‰å–é¤æ™‚é–“æ’åºï¼ˆæœ€æ—©çš„å–é¤æ™‚é–“åœ¨å‰ï¼‰
            filteredOrders.sort((a, b) => {
                // è¨ˆç®—è¨‚å–® a çš„æœ‰æ•ˆæ’åºæ™‚é–“
                let timeA;
                if (a.pickup_time) {
                    // æœ‰é ç´„æ™‚é–“:ä½¿ç”¨é ç´„æ™‚é–“
                    timeA = new Date(a.pickup_time);
                } else {
                    // å…§ç”¨å³æ™‚é»é¤:ä½¿ç”¨é ä¼°å®Œæˆæ™‚é–“(ä¸‹å–®å¾Œ 20 åˆ†é˜)
                    timeA = new Date(new Date(a.created_at).getTime() + 20 * 60 * 1000);
                }
                
                // è¨ˆç®—è¨‚å–® b çš„æœ‰æ•ˆæ’åºæ™‚é–“
                let timeB;
                if (b.pickup_time) {
                    timeB = new Date(b.pickup_time);
                } else {
                    timeB = new Date(new Date(b.created_at).getTime() + 20 * 60 * 1000);
                }
                
                // æŒ‰æœ‰æ•ˆæ’åºæ™‚é–“æ’åº(æœ€æ—©çš„åœ¨å‰)
                return timeA - timeB;
            });

            // âœ… é—œéµï¼šå¯¦éš›æ¸²æŸ“åˆ° DOM
            if (filteredOrders.length === 0) {
                ordersGrid.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“­ æš«ç„¡${getFilterDisplayName(currentFilter)}</h3>
                        <p>ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</p>
                    </div>
                `;
            } else {
                // å°‡æ¯å€‹è¨‚å–®è½‰æ›ç‚º HTML ä¸¦æ’å…¥åˆ°é é¢
                ordersGrid.innerHTML = filteredOrders
                    .map(order => renderOrderCard(order))
                    .join('');
            }

            // æ›´æ–°çµ±è¨ˆ
            updateStats();
        }
        function updateTotal(orderId) {
            const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
            if (!orderCard) return;

            const inputs = orderCard.querySelectorAll('.side-dishes select');
            let sideTotal = 0;

            inputs.forEach(select => {
                const qty = parseInt(select.value, 10) || 0;
                const price = Number(select.dataset.price) || 0;
                sideTotal += qty * price;
            });

            // æ‰¾åˆ°ç¸½é‡‘é¡å…ƒç´ 
            const totalEl = orderCard.querySelector('.order-total');
            if (totalEl) {
                // å–å¾—è¨‚å–®åŸå§‹é‡‘é¡
                const order = orders.find(o => o.id == orderId);
                const baseTotal = Number(order?.total_price || 0);
                totalEl.textContent = `NT$ ${(baseTotal + sideTotal).toFixed(0)}`;
            }
        }

        // å–å¾—ç¯©é¸å™¨é¡¯ç¤ºåç¨±
        function getFilterDisplayName(filter) {
            const filterMap = {
                'all': 'å…¨éƒ¨è¨‚å–®',
                'pending': 'å¾…è™•ç†',
                'unassigned': 'å¾…åˆ†é…',
                'pending_payment':'å¾…çµå¸³',
                'completed': 'å·²å®Œæˆ',
                'history': 'æ­·å²è¨‚å–®'
            };
            return filterMap[filter] || filter;
        }

        // æ›´æ–°è¨‚å–®ç‹€æ…‹ï¼ˆå‘¼å«çœŸå¯¦APIï¼‰
        async function updateOrderStatus(orderId, newStatus) {
            try {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯è©²ç‹€æ…‹
                const currentOrder = orders.find(o => o.id == orderId);
                if (currentOrder && currentOrder.status === newStatus) {
                    console.log(`è¨‚å–® ${orderId} å·²ç¶“æ˜¯ ${newStatus} ç‹€æ…‹`);
                    return;
                }

                // åœç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderCard) {
                    const buttons = orderCard.querySelectorAll('.status-btn');
                    buttons.forEach(btn => btn.disabled = true);
                   
                    // æ·»åŠ è¼‰å…¥æ•ˆæœ
                    const targetBtn = orderCard.querySelector(`.status-btn.${newStatus}`);
                    if (targetBtn) {
                        targetBtn.textContent = 'æ›´æ–°ä¸­...';
                    }
                }


                console.log(`æ­£åœ¨æ›´æ–°è¨‚å–® ${orderId} ç‹€æ…‹ç‚º: ${newStatus}`);


                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });


                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIéŒ¯èª¤å›æ‡‰:', errorText);
                    throw new Error(`APIéŒ¯èª¤ ${response.status}: ${errorText}`);
                }


                const data = await response.json();
                console.log('APIå›æ‡‰æˆåŠŸ:', data);


                // ç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹
                const orderIndex = orders.findIndex(o => o.id == orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].status = newStatus;
                   
                    // å¦‚æœç•¶å‰åœ¨å¾…è™•ç†ç¯©é¸å™¨ï¼Œä¸”ç‹€æ…‹æ”¹ç‚ºå·²å®Œæˆï¼Œå‰‡å¾ç•«é¢ç§»é™¤
                    if (currentFilter === 'pending' && newStatus === 'completed') {
                        // é‡æ–°å–å¾—è¨‚å–®å¡ç‰‡å…ƒç´ 
                        const orderCardElement = document.querySelector(`[data-order-id="${orderId}"]`);
                       
                        // æ·»åŠ ä¸€å€‹å‹•ç•«æ•ˆæœï¼Œè®“è¨‚å–®å¡ç‰‡æ»‘å‡º
                        if (orderCardElement) {
                            orderCardElement.style.transition = 'all 0.5s ease-out';
                            orderCardElement.style.transform = 'translateX(100%)';
                            orderCardElement.style.opacity = '0';
                           
                            // å»¶é²å¾Œé‡æ–°æ¸²æŸ“ï¼Œç¢ºä¿å‹•ç•«å®Œæˆ
                            setTimeout(() => {
                                renderOrders();
                            }, 500);
                        } else {
                            renderOrders();
                        }
                    } else {
                        renderOrders();
                    }
                }


                showMessage(`è¨‚å–® #${orderId} ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œ${getStatusText(newStatus)}ã€`, 'success');


            } catch (error) {
                console.error('æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
                showMessage(`æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
               
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ - é‡æ–°æ¸²æŸ“æ•´å€‹è¨‚å–®åˆ—è¡¨
                renderOrders();
            }
        }


        // è¨­å®šç¯©é¸å™¨
        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
           
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderOrders();
                });
            });
        }


        // è¼‰å…¥è¨‚å–®ï¼ˆå‘¼å«çœŸå¯¦APIï¼‰
        async function loadOrders() {
            try {
                updateConnectionStatus('ğŸŸ¡ è¼‰å…¥ä¸­...', 'loading');
                console.log('æ­£åœ¨å¾APIè¼‰å…¥è¨‚å–®...');
                const response = await fetch(`${API_BASE_URL}/orders`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('APIè¿”å›çš„è¨‚å–®è³‡æ–™:', data);
               
                orders = data.map(order => ({
                    ...order,
                    status: order.status || 'pending', // é è¨­ç‹€æ…‹ç‚ºå¾…è™•ç†
                    parsed_items: order.parsed_items || []
                }));
               
                renderOrders();
                updateConnectionStatus(`ğŸŸ¢ å·²é€£ç·š (${orders.length} ç­†è¨‚å–®)`, 'connected');
               
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${orders.length} ç­†è¨‚å–®`);
               
            } catch (error) {
                console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                updateConnectionStatus('ğŸ”´ é€£ç·šå¤±æ•—', 'disconnected');
               
                const ordersGrid = document.getElementById('ordersGrid');
                ordersGrid.innerHTML = `
                    <div class="empty-state">
                        <h3>âš ï¸ è¼‰å…¥å¤±æ•—</h3>
                        <p>ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯API: ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #999;">
                            è«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨æ˜¯å¦åœ¨ ${API_BASE_URL} é‹è¡Œ
                        </p>
                    </div>
                `;
               
                showMessage(`è¼‰å…¥è¨‚å–®å¤±æ•—: ${error.message}`, 'error');
            }
        }

// æ–°å¢ï¼šå¾ä¸‹æ‹‰é¸å–®åˆ†é…æ¡Œè™Ÿçš„å‡½æ•¸
async function assignTableFromDropdown(orderId) {
    try {
        const tableSelect = document.getElementById(`tableSelect-${orderId}`);
        const tableNumber = tableSelect?.value?.trim();
       
        if (!tableNumber) {
            showMessage('è«‹é¸æ“‡æ¡Œè™Ÿ', 'error');
            return;
        }

        // ä¿®æ­£ï¼šåŒæ™‚å‚³é€ status å’Œ table_number
        const response = await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                status: 'pending',
                table_number: tableNumber  // âœ… åŠ å…¥é€™ä¸€è¡Œ
            })
        });

        if (!response.ok) {
            throw new Error(`APIéŒ¯èª¤ ${response.status}`);
        }

        // æ›´æ–°æœ¬åœ°è¨‚å–®è³‡æ–™
        const orderIndex = orders.findIndex(o => o.id == orderId);
        if (orderIndex !== -1) {
            orders[orderIndex].table_number = tableNumber;
            orders[orderIndex].status = 'pending';
        }

        // è‡ªå‹•åˆ‡æ›åˆ°å¾…è™•ç†åˆ†é¡
        currentFilter = 'pending';
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => btn.classList.remove('active'));
        const pendingBtn = document.querySelector('[data-filter="pending"]');
        if (pendingBtn) {
            pendingBtn.classList.add('active');
        }

        renderOrders();
       
        const displayText = tableNumber === 'å¤–å¸¶' ? 'å¤–å¸¶' : `${tableNumber}è™Ÿæ¡Œ`;
        showMessage(`è¨‚å–® #${orderId} å·²åˆ†é…è‡³ ${displayText}ï¼Œå·²åˆ‡æ›è‡³å¾…è™•ç†`, 'success');

    } catch (error) {
        console.error('åˆ†é…æ¡Œè™Ÿå¤±æ•—:', error);
        showMessage(`åˆ†é…æ¡Œè™Ÿå¤±æ•—: ${error.message}`, 'error');
    }
}

        // addSideDishesï¼šæ›´ç©©å¥çš„å‰ç«¯å¯¦ä½œï¼ˆæœ‰éŒ¯èª¤è™•ç†ã€æª¢æŸ¥ response.okã€ç›´æ¥æ›´æ–°æœ¬åœ° ordersï¼‰
        async function addSideDishes(orderId) {
            try {
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (!orderCard) {
                    showMessage('æ‰¾ä¸åˆ°è©²è¨‚å–®å¡ç‰‡ï¼Œè«‹é‡æ–°æ•´ç†', 'error');
                    return;
                }

                const selects = orderCard.querySelectorAll('.side-dishes select');
                const inputs = orderCard.querySelectorAll('.side-dishes input');
                const selectedSides = [];
                let sideTotal = 0;

                inputs.forEach(input => {
                    const qty = parseInt(input.value, 10) || 0;
                    const price = Number(input.dataset.price) || 0;
                    const name = input.dataset.name || '';
                    if (qty > 0 && name) {
                        // ä¿è­‰æ•¸å­—å‹åˆ¥
                        sideDishes.push({ item_name: name, quantity: Number(qty), price: Number(price) });
                        sideTotal += Number(qty) * Number(price);
                    }
                });

                selects.forEach(select => {
                    const qty = parseInt(select.value, 10) || 0;
                    const price = Number(select.dataset.price) || 0;
                    const name = select.dataset.name || '';
                    if (qty > 0 && name) {
                        selectedSides.push({ item_name: name, quantity: qty, price });
                        sideTotal += qty * price;
                    }
                });

                if (selectedSides.length === 0) {
                    showMessage('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€ä»½å°èœ', 'error');
                    return;
                }

                // å‘¼å«å¾Œç«¯ API
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/add-sides`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sideDishes: selectedSides })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API éŒ¯èª¤ ${response.status}: ${errText}`);
                }

                const data = await response.json();
                console.log('åŠ å…¥å°èœ API å›å‚³ï¼š', data);


                // é æœŸå¾Œç«¯å›å‚³ updated_orderï¼ˆå®Œæ•´çš„è³‡æ–™åˆ—ï¼‰
                if (data.updated_order) {
                    const updated = data.updated_order;
                    // parsed_items å¯èƒ½åœ¨ updated.itemsï¼ˆJSONï¼‰ï¼Œç¢ºä¿æ­£ç¢ºè§£æ
                    updated.parsed_items = updated.items ? (typeof updated.items === 'string' ? JSON.parse(updated.items) : updated.items) : [];
                    updated.total_price = Number(updated.total_price) || 0;


                    // æ›´æ–°æœ¬åœ° orders é™£åˆ—ï¼ˆé¿å…æ•´é  reloadï¼‰
                    const idx = orders.findIndex(o => o.id == orderId);
                    if (idx !== -1) {
                        orders[idx] = { ...orders[idx], ...updated };
                    }
                    renderOrders();
                    showMessage(`è¨‚å–® #${orderId} å·²åŠ å…¥å°èœä¸¦æ›´æ–°é‡‘é¡`, 'success');
                } else {
                    showMessage('ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ä¼ºæœå™¨æ—¥èªŒ', 'error');
                }


            } catch (err) {
                console.error('addSideDishes éŒ¯èª¤ï¼š', err);
                showMessage(`åŠ å…¥å°èœå¤±æ•—ï¼š${err.message}`, 'error');
            }
        }        
        //åˆªé™¤å°èœåŠŸèƒ½
        async function removeSideDishes(orderId) {
            try {
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (!orderCard) return showMessage('æ‰¾ä¸åˆ°è¨‚å–®å¡ç‰‡', 'error');
    
                const selects = orderCard.querySelectorAll('.side-dishes select');
                const selectedSides = [];
    
                selects.forEach(select => {
                    const qty = parseInt(select.value, 10) || 0;
                    const name = select.dataset.name || '';
                    if (qty > 0 && name) {
                        selectedSides.push({ item_name: name, quantity: qty });
                    }
                });
    
                if (selectedSides.length === 0) {
                    showMessage('è«‹å…ˆè¼¸å…¥è¦åˆªé™¤çš„å°èœæ•¸é‡', 'error');
                    return;
                }
    
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/remove-sides`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sideDishes: selectedSides })
                });
    
    
                if (!response.ok) throw new Error(`APIéŒ¯èª¤ ${response.status}`);
    
    
                const data = await response.json();
                console.log('åˆªé™¤å°èœ API å›å‚³ï¼š', data);
    
                // æ›´æ–°å‰ç«¯ orders
                if (data.updated_order) {
                    const updated = data.updated_order;
                    updated.parsed_items = updated.items || [];
                    updated.total_price = Number(updated.total_price) || 0;
                    const idx = orders.findIndex(o => o.id == orderId);
                    if (idx !== -1) orders[idx] = { ...orders[idx], ...updated };
                    renderOrders();
                    showMessage(`è¨‚å–® #${orderId} å·²åˆªé™¤å°èœä¸¦æ›´æ–°é‡‘é¡`, 'success');
                }
            } catch (err) {
                console.error('removeSideDishes éŒ¯èª¤ï¼š', err);
                showMessage(`åˆªé™¤å°èœå¤±æ•—ï¼š${err.message}`, 'error');
            }
        }

        function showRevenueReport(period) {
         const now = new Date();
         let filtered;
            
         if (period === 'today') {
             filtered = orders.filter(o => isToday(o.created_at));
         } else if (period === 'month') {
              filtered = orders.filter(o => {
                   const date = new Date(o.created_at);
                   return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
              });
          }

           const totalRevenue = filtered.reduce((sum, o) => sum + Number(o.total_price), 0);
           const orderCount = filtered.length;
            
          alert(`ã€${period === 'today' ? 'ä»Šæ—¥' : 'æœ¬æœˆ'}å ±è¡¨åˆ†æã€‘\nç¸½ç‡Ÿæ”¶ï¼šNT$ ${totalRevenue}\nç¸½è¨‚å–®æ•¸ï¼š${orderCount}\nå¹³å‡å®¢å–®åƒ¹ï¼šNT$ ${(totalRevenue/orderCount || 0).toFixed(0)}`);
        }
        
        // æ¸¬è©¦APIé€£ç·š
        async function testApiConnection() {
            try {
                console.log('æ¸¬è©¦APIé€£ç·š...');
                const response = await fetch(`${API_BASE_URL.replace('/api', '')}/health`);
                const data = await response.json();
                console.log('APIå¥åº·æª¢æŸ¥:', data);
                return true;
            } catch (error) {
                console.error('APIé€£ç·šæ¸¬è©¦å¤±æ•—:', error);
                return false;
            }
        }

    //    function startAutoRefresh() {
    //         // æ¯ 10 ç§’è‡ªå‹•åˆ·æ–°è¨‚å–®
    //         setInterval(() => {
    //             renderOrders(); // å‡è¨­ä½ æœ‰é€™å€‹å‡½å¼
    //         }, 10000);
    //     }

        // é–‹å§‹æ™‚é–“æ›´æ–°
        function startTimeUpdate() {
            updateCurrentTime();
            if (currentTimeInterval) {
                clearInterval(currentTimeInterval);
            }
            currentTimeInterval = setInterval(updateCurrentTime, 1000);
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        async function initializeApp() {
            console.log('åˆå§‹åŒ–è¨‚å–®ç®¡ç†ç³»çµ±...');
            console.log('APIåŸºç¤ç¶²å€:', API_BASE_URL);
           
            setupFilters();
            startTimeUpdate();
           
            // æ¸¬è©¦APIé€£ç·š
            const isApiOnline = await testApiConnection();
            if (!isApiOnline) {
                updateConnectionStatus('ğŸ”´ APIé›¢ç·š', 'disconnected');
                showMessage('ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯APIï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨æ˜¯å¦é‹è¡Œ', 'error');
                return;
            }
            // è¼‰å…¥è¨‚å–®è³‡æ–™
            await loadOrders();
           
            // é–‹å§‹è‡ªå‹•é‡æ–°æ•´ç†
            // startAutoRefresh();
           
            console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', initializeApp);

        // æ¸…ç†å®šæ™‚å™¨
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (currentTimeInterval) clearInterval(currentTimeInterval);
        });

        // æ‰‹å‹•é‡æ–°æ•´ç†
        function manualRefresh() {
            console.log('æ‰‹å‹•é‡æ–°æ•´ç†è¨‚å–®...');
            loadOrders();
        }
   
        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                manualRefresh();
            }
        });

        // éŒ¯èª¤è™•ç†ï¼šå…¨åŸŸéŒ¯èª¤æ•ç²
        window.addEventListener('error', function(e) {
            console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
            showMessage('ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
        });

        // Promise rejection è™•ç†
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªè™•ç†çš„PromiseéŒ¯èª¤:', e.reason);
            showMessage('ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·š', 'error');
        });
    </script>
</body>

</html>
